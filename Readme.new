# Financial Analysis Agent ðŸ“Š

AI-powered financial data analysis agent using Mistral LLM via Ollama. Query financial data using natural language and get comprehensive analysis with visualizations.

## Features

- ðŸ¤– **Natural Language Interface**: Ask questions in plain English
- ðŸ”„ **Sequential Multi-Step Execution**: Plans break down into logical steps with state management
- ðŸ“Š **Automated Visualizations**: Revenue trends, profitability ratios, comparative analysis
- ðŸ§  **Intelligent Planning**: Mistral LLM creates optimal execution plans
- âœ… **Robust Validation**: Verifies data quality before operations
- ðŸ“„ **PDF Report Generation**: Professional reports with analysis and visualizations
- ðŸ“ˆ **Interactive Dashboard**: Streamlit-based UI with chat interface
- ðŸ› ï¸ **Extensible Tools**: Modular plotting and calculation functions

## Architecture Overview

### Previous Architecture (Single Action)
```
User Query â†’ Planner â†’ Single Action â†’ Executor â†’ Result
```

### New Architecture (Sequential)
```
User Query â†’ Planner â†’ Multi-Step Plan â†’ Sequential Executor â†’ Results
                                              â†“
                                    State flows between steps
                                    (DataFrame, visualizations, tables)
```

### Core Components

1. **Planner** (`agent/planner.py`)
   - Uses Mistral LLM to create multi-step execution plans
   - Outputs `{"steps": [...]}` instead of single action
   - Validates all steps upfront
   - Supports 11 different action types
   - Automatic JSON repair and retry logic

2. **Executor** (`agent/executor.py`)
   - Maintains `ExecutionState` across steps:
     - Current DataFrame (modified by each step)
     - Generated visualizations
     - Summary tables
     - Exported files
   - Executes steps sequentially
   - Comprehensive error handling per step
   - Proactive data validation

3. **Orchestrator** (`agent/orchestrator.py`)
   - Manages the complete pipeline
   - Displays results progressively
   - Tracks execution history
   - Provides usage statistics

## Recent Improvements

### Intelligence Enhancements

#### 1. **Automatic JSON Repair**
The planner now automatically repairs common JSON errors:
- Removes markdown code blocks
- Fixes trailing commas
- Replaces invalid variables with safe values
- Wraps arrays in `{"steps": [...]}` structure

#### 2. **Proactive Data Validation**
Before each operation, the system validates:
- **For trends**: Sufficient time periods?
- **For comparisons**: Multiple comparable companies?
- **For ratios**: Non-zero denominators?
- **For correlations**: Enough complete observations?

#### 3. **Intelligent Error Recovery**
When a metric is invalid:
```python
# If "profit_margin" lacks sufficient data...
# System automatically searches for alternatives:
find_plottable_metric(df, preferred="profit_margin")
# â†’ Returns "net_income" or best available metric
```

#### 4. **Retry with Feedback**
If LLM generates invalid plan:
```python
# Attempt 1: Plan with error
# System: "Missing required parameter 'year' in compare_companies"

# Attempt 2: LLM receives feedback
user_query + "\n\nPREVIOUS ATTEMPT FAILED: Missing 'year'. 
REMEMBER: compare_companies needs both 'metric' AND 'year'"

# Attempt 3: Corrected plan
```

## Project Structure

```
.
â”œâ”€â”€ agent/                  # Agent core logic
â”‚   â”œâ”€â”€ orchestrator.py     # Main orchestrator
â”‚   â”œâ”€â”€ planner.py          # LLM-based planning
â”‚   â””â”€â”€ executor.py         # Tool execution with state management
â”œâ”€â”€ tools/                  # Analysis tools
â”‚   â”œâ”€â”€ visualization.py    # Plotly visualizations
â”‚   â”œâ”€â”€ tool_mapping.py     # Tool registry
â”‚   â”œâ”€â”€ reporting.py        # PDF report generation
â”‚   â””â”€â”€ analysis.py         # Financial calculations
â”œâ”€â”€ scripts/               # Setup scripts
â”‚   â””â”€â”€ clean_dataset.py   # Data preprocessing
â”œâ”€â”€ data/                  # Data directory
â”‚   â”œâ”€â”€ processed.csv      # Processed data
â”‚   â””â”€â”€ raw.csv            # Raw CSV data
â””â”€â”€ app.py                 # Streamlit app
```

## Setup

### Prerequisites

- Python 3.12+
- Ollama
- Mistral model for Ollama

### 1. Install Dependencies

```bash
pip install polars plotly streamlit requests ollama fpdf kaleido
```

### 2. Install and Setup Ollama

```bash
# Install Ollama (macOS/Linux)
curl -fsSL https://ollama.ai/install.sh | sh

# Start Ollama server
ollama serve

# In another terminal, pull Mistral
ollama pull mistral
```

### 3. Prepare Data

```bash
# Place your financial data CSV in data/raw.csv
# Run preprocessing
python scripts/clean_dataset.py
```

### 4. Verify Setup

```bash
# Test the agent
python agent/orchestrator.py
```

## Usage

### Streamlit App (Recommended)

```bash
streamlit run app.py
```

Then open your browser to `http://localhost:8501`

### CLI Interface

```bash
python agent/orchestrator.py
```

Or use interactive mode:
```python
from agent.orchestrator import interactive_mode
interactive_mode()
```

### Programmatic Usage

#### Simple Query
```python
from agent.orchestrator import quick_query

state = quick_query(
    "Filter to companies 1-5, calculate profit margins, and plot the trend"
)

# Access results
print(f"Visualizations: {len(state.visualizations)}")
print(f"Tables: {len(state.tables)}")
print(f"Exports: {state.exports}")
```

#### Agent Instance
```python
from agent.orchestrator import FinancialAnalysisAgent

agent = FinancialAnalysisAgent(verbose=True)

state = agent.query(
    "Filter to 2020-2023, compute ROE, plot trends, and create report"
)

# Show statistics
agent.show_statistics()
```

#### Batch Processing
```python
agent = FinancialAnalysisAgent()

queries = [
    "Compare revenue across companies in 2023",
    "Calculate profit margins and show trends",
    "Export top 10 companies by ROE to Excel"
]

results = agent.batch_query(queries)
```

## Available Actions (11 Total)

### Data Operations

1. **filter_data**
   - Subset data by conditions
   - Example: `{"action": "filter_data", "conditions": [{"column": "year", "operator": ">=", "value": 2020}]}`

2. **compute_summary_stats**
   - Calculate mean, median, std, etc.
   - Example: `{"action": "compute_summary_stats", "columns": ["revenue", "net_income"], "group_by": "year"}`

3. **export_table**
   - Save to CSV/Excel
   - Example: `{"action": "export_table", "format": "csv", "filename": "results.csv"}`

### Analysis Operations

4. **yoy_growth**
   - Year-over-year growth rates
   - Example: `{"action": "yoy_growth", "metric": "revenue", "periods": 1}`

5. **rolling_average**
   - Moving averages
   - Example: `{"action": "rolling_average", "metric": "revenue", "window": 3}`

6. **compute_margin**
   - Ratios between metrics
   - Example: `{"action": "compute_margin", "numerator": "net_income", "denominator": "revenue", "output_col": "profit_margin"}`

7. **compute_share**
   - Percentage calculations
   - Example: `{"action": "compute_share", "value_col": "segment_revenue", "total_col": "total_revenue", "output_col": "market_share"}`

### Visualization Operations

8. **plot_trend**
   - Time series line charts
   - Example: `{"action": "plot_trend", "metric": "revenue", "company_ids": [1, 2, 3]}`

9. **compare_companies**
   - Cross-sectional bar charts
   - Example: `{"action": "compare_companies", "metric": "net_income", "year": 2023}`

10. **correlation**
    - Correlation heatmaps
    - Example: `{"action": "correlation", "metrics": ["revenue", "net_income", "total_assets"]}`

### Reporting

11. **generate_report**
    - Compile comprehensive PDF reports
    - Example: `{"action": "generate_report", "custom_filename": "Q4_Analysis"}`

## Example Queries

### Basic Analysis
```
"Show me the revenue trend for companies 1, 2, and 3 from 2015 to 2020"
```

### Multi-Step Workflow
```
"Filter to companies 1-5, calculate profit margins, and plot the trend"
```
This generates:
1. filter_data (companies 1-5)
2. compute_margin (net_income / revenue)
3. plot_trend (profit_margin)

### Complex Analysis
```
"Filter to 2020-2023, compute ROE for each company, 
 calculate 3-year rolling averages, plot the trends, 
 show correlation with revenue, and create a comprehensive report"
```
This generates ~6 steps with sequential state management.

### Comparative Analysis
```
"Compare company 1's ROE against its industry in 2020"
"Which companies have the highest revenue in 2023?"
```

### Batch Queries
```
"Show me summary stats for revenue and assets in 2023, then export to CSV"
```

## State Management

### ExecutionState Class
```python
class ExecutionState:
    df: pl.DataFrame              # Current working data
    visualizations: List[Figure]  # Generated plots
    tables: List[Dict]            # Summary tables
    exports: List[str]            # Exported file paths
    metadata: Dict                # Additional info
```

### How State Flows
```
Step 1: filter_data
  Input: Original DataFrame
  Output: Filtered DataFrame
  State: df updated

Step 2: compute_margin
  Input: Filtered DataFrame
  Output: DataFrame + new margin column
  State: df updated

Step 3: plot_trend
  Input: DataFrame with margin column
  Output: Plotly Figure
  State: visualization added

Step 4: export_table
  Input: Current DataFrame
  Output: CSV file
  State: export path added
```

## Available Metrics (95 Total)

### Financial Basics
`revenue`, `net_income`, `total_assets`, `equity`, `total_debt`, `total_liabilities`

### Ratios
`roe`, `roa`, `current_ratio`, `quick_ratio`, `leverage`, `asset_leverage`, `equity_leverage`

### Margins
`gross_margin`, `operating_margin`, `net_sales_margin`

### Efficiency
`asset_turnover`, `fixed_assets_turnover`, `receivables_turnover`, `interest_coverage`

### Other
`employee_count`, `company_size`, `ranking`, `year`, `company_id`

See `planner.py` for complete list of 95 available metrics.

## Advanced Features

### Automatic Metric Fallback
When requested metric lacks sufficient data:
```python
# User requests: "plot_trend" for "profit_margin"
# System detects: insufficient data points
# Action: Automatically finds alternative (e.g., "net_income")
# User sees: Warning message + plot with alternative metric
```

### Plan Validation
All plans are validated before execution:
- Required parameters present
- Metrics exist in dataset
- Filter conditions valid
- Year references correct

### Error Recovery
```python
try:
    state = agent.query("ambiguous query")
except ValidationError as e:
    # Insufficient data
    print(f"Data validation failed: {e}")
except VisualizationError as e:
    # Cannot create plot
    print(f"Visualization failed: {e}")
except ValueError as e:
    # Invalid parameters
    print(f"Invalid input: {e}")
```

## Configuration

### Environment Variables
```bash
export FINANCE_DB_PATH="data/finance.db"
export OLLAMA_URL="http://localhost:11434"
export OLLAMA_MODEL="mistral:latest"
export AGENT_MAX_RETRIES=2
```

### Config File
Edit `config.py` for additional settings:
- Data paths
- Model parameters
- Retry logic
- Validation thresholds

## Performance Tips

- **Limit company_ids**: Query fewer companies for faster responses
- **Use specific years**: Narrow date ranges reduce processing time
- **Batch related queries**: Use `batch_query()` for multiple analyses
- **Cache results**: The agent maintains execution history

## Known Limitations

1. **No localStorage**: Runs in standard Python environment (not browser-based)
2. **Requires local Ollama**: Must have Mistral running locally
3. **Sequential execution**: Steps execute one at a time (no parallelization)
4. **Single-user**: No concurrent request handling
5. **Memory per session**: No persistence between sessions
6. **Visualization exports**: Requires kaleido for PDF image generation

## Troubleshooting

### "Ollama is not running"
```bash
# Start Ollama
ollama serve
```

### "Model 'mistral' not found"
```bash
# Pull the model
ollama pull mistral
```

### "No module named 'polars'"
```bash
# Install dependencies
pip install polars plotly streamlit requests ollama fpdf kaleido
```

### "Invalid JSON from planner"
- The system automatically retries with error feedback
- Check Ollama is running: `curl http://localhost:11434/api/tags`
- Verify model is loaded: `ollama list`

### "Insufficient data for visualization"
- The system automatically suggests alternative metrics
- Check data has sufficient non-null values
- Verify year/company filters aren't too restrictive

## Advanced Usage Examples

### Profitability Analysis
```python
query = """
Filter to public companies in years 2020-2023,
compute ROE and ROA for each company-year,
calculate 2-year rolling averages for both metrics,
show correlation between ROE and revenue growth,
plot trends for top 5 companies by average ROE,
create comparison of 2023 values,
generate comprehensive PDF report
"""

state = agent.query(query)
# Generates: 7 steps, multiple visualizations, PDF report
```

### Data Quality Pipeline
```python
from agent.orchestrator import FinancialAnalysisAgent
from tools.analysis import flag_invalid_values, flag_anomalous_margin

agent = FinancialAnalysisAgent()

# The agent can handle quality checks through natural language
query = """
Flag invalid values in revenue and assets,
flag anomalous profit margins,
compute summary statistics grouped by year,
export flagged records to CSV for review
"""

state = agent.query(query)
```

### Multi-Temporal Comparison
```python
query = """
For companies 1-10:
- Calculate YoY growth rates for revenue
- Compute 3-year moving averages
- Show correlation matrix of key metrics
- Compare 2023 performance vs 3-year average
- Export full analysis to Excel
"""

state = agent.query(query)
```

## Statistics & Monitoring

```python
agent = FinancialAnalysisAgent()

# Run multiple queries...
agent.query("query 1")
agent.query("query 2")

# Show statistics
agent.show_statistics()

# Output:
# Total queries: 15
# Successful: 13 (86.7%)
# Planning failed: 1 (6.7%)
# Execution failed: 1 (6.7%)
# Average steps per query: 3.2
# Most used actions:
#   â€¢ filter_data: 13
#   â€¢ plot_trend: 9
#   â€¢ compute_margin: 7
```

## Tool Registry

See `tools/tool_mapping.py` for comprehensive tool metadata:
- Function signatures
- Required/optional parameters
- Validation requirements
- Example usage
- Error types

```python
from tools.tool_mapping import (
    TOOL_REGISTRY,
    get_tool_metadata,
    search_tools_by_keyword,
    print_all_tools_summary
)

# Print all available tools
print_all_tools_summary()

# Search for specific tools
growth_tools = search_tools_by_keyword("growth")

# Get detailed metadata
meta = get_tool_metadata("yoy_growth")
```

## Future Enhancements

- [ ] Add more financial metrics (P/E ratio, debt ratios, etc.)
- [ ] Support for custom metric definitions
- [ ] Multi-year comparative analysis
- [ ] Industry sector analysis
- [ ] Forecasting and trend prediction
- [ ] API endpoint for programmatic access
- [ ] Parallel execution of independent steps
- [ ] Persistent memory across sessions
- [ ] Integration with external data sources
- [ ] Real-time data streaming support

## Contributing

Contributions welcome! Please:
1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Submit a pull request

## License

MIT License - feel free to use and modify for your needs

## Support

For issues and questions:
- Check the troubleshooting section above
- Review example queries in this README
- Inspect agent execution details with `verbose=True`
- Check tool validation requirements in `tool_mapping.py`

## Citation

If you use this agent in your research or project, please cite:

```bibtex
@software{financial_analysis_agent,
  title = {Financial Analysis Agent with Sequential LLM Planning},
  author = {Your Name},
  year = {2025},
  url = {https://github.com/yourusername/financial-analysis-agent}
}
```

---

**Version**: 2.0 (Sequential Agent Architecture)  
**Last Updated**: January 2025  
**Python Version**: 3.12+  
**License**: MIT
